<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subnet Calculator</title>
    <link rel="stylesheet" href="../static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script>
        // Функция для переключения темы
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            // Обновляем тему
            body.setAttribute('data-theme', newTheme);
            
            // Сохраняем тему в localStorage
            localStorage.setItem('theme', newTheme);
            
            // Обновляем иконку
            const icon = document.querySelector('.theme-toggle i');
            icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        // Инициализация темы при загрузке страницы
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', savedTheme);
            
            // Устанавливаем правильную иконку
            const icon = document.createElement('i');
            icon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            document.querySelector('.theme-toggle').appendChild(icon);
        });
    </script>
</head>
<body data-theme="dark">
    <div class="container">
        <div class="theme-toggle" onclick="toggleTheme()"></div>
<header>
            <h1>Subnet Calculator</h1>
            <nav>
                <a href="/"><i class="fas fa-home"></i> Home</a> | 
                <a href="/ip-converter"><i class="fas fa-exchange-alt"></i> IP Converter</a> | 
                <a href="/subnet-calculator" class="active"><i class="fas fa-calculator"></i> Subnet Calculator</a>
            </nav>
        </header>
        <main>
            <section class="card">
                <h2>Calculate Subnet Parameters</h2>
                <form id="subnet-form" hx-post="/api/calculate-subnet" hx-swap="none" hx-target="#subnet-result" class="form-grid">
                    <div class="form-group">
                        <label for="ip">IP Address</label>
                        <input type="text" id="ip" name="ip" placeholder="e.g., 192.168.1.0" required>
                    </div>
                    <div class="form-group">
                        <label for="current_mask">Current Network Mask</label>
                        <input type="text" id="current_mask" name="current_mask" 
                               placeholder="e.g., 24 or 255.255.255.0" required>
                    </div>
                    <div class="form-group">
                        <label for="new_mask">New Subnet Mask</label>
                        <input type="text" id="new_mask" name="new_mask" 
                               placeholder="e.g., 26 or 255.255.255.192" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-calculator"></i> Calculate
                        </button>
                    </div>
                </form>
                
                <div id="subnet-result">
                    <div class="result-card" hx-swap-oob="true">
                        <h3><i class="fas fa-info-circle"></i> Subnet Information</h3>
                        <div class="result-content">
                            <p>Enter an IP address and subnet masks to calculate the subnet parameters.</p>
                            <div id="error-display" class="error-message"></div>
                            <div id="results-display" style="display: none;">
                                <div class="result-grid" id="results-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    <script>
        // Reset button state when request starts
        document.querySelector('#subnet-form').addEventListener('htmx:beforeRequest', function(evt) {
            const submitBtn = document.querySelector('#subnet-form button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating...';
            
            document.getElementById('error-display').textContent = '';
            document.getElementById('error-display').style.display = 'none';
            document.getElementById('results-display').style.display = 'none';
        });
        
        // Handle successful response
        document.querySelector('#subnet-form').addEventListener('htmx:afterRequest', function(evt) {
            const submitBtn = document.querySelector('#subnet-form button[type="submit"]');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-calculator"></i> Calculate';
            
            const resultsContent = document.getElementById('results-content');
            const data = JSON.parse(evt.detail.xhr.response);
            
            resultsContent.innerHTML = `
                <div class="result-item network-address">
                    <div class="label"><i class="fas fa-network-wired"></i> Network Address</div>
                    <div class="value">${data.subnet_address}</div>
                </div>
                <div class="result-item">
                    <div class="label"><i class="fas fa-project-diagram"></i> Subnet Bits</div>
                    <div class="value">${data.subnet_bits}</div>
                </div>
                <div class="result-item">
                    <div class="label"><i class="fas fa-sitemap"></i> Subnets Created</div>
                    <div class="value">${data.subnets_created.toLocaleString()}</div>
                </div>
                <div class="result-item">
                    <div class="label"><i class="fas fa-hashtag"></i> Total Addresses</div>
                    <div class="value">${data.addresses_in_subnet.toLocaleString()}</div>
                </div>
                <div class="result-item">
                    <div class="label"><i class="fas fa-users"></i> Usable Hosts</div>
                    <div class="value">${data.usable_hosts.toLocaleString()}</div>
                </div>
                <div class="result-item host-range">
                    <div class="label"><i class="fas fa-server"></i> Usable Host Range</div>
                    <div class="value">${data.first_host} - ${data.last_host}</div>
                </div>
                <div class="result-item broadcast-address">
                    <div class="label"><i class="fas fa-broadcast-tower"></i> Broadcast Address</div>
                    <div class="value">${data.broadcast_address}</div>
                </div>
                <div class="result-item mask-info">
                    <div class="label"><i class="fas fa-mask"></i> New Subnet Mask</div>
                    <div class="value">${data.new_mask_dotted} <small>(/${data.new_mask})</small></div>
                </div>
            `;
            document.getElementById('results-display').style.display = 'block';
            
            // Smooth scroll to results
            resultsContent.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        });
        
        // Handle errors
        document.querySelector('#subnet-form').addEventListener('htmx:error', function(evt) {
            const submitBtn = document.querySelector('#subnet-form button[type="submit"]');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-calculator"></i> Calculate';
            
            const errorDisplay = document.getElementById('error-display');
            try {
                const errorData = JSON.parse(evt.detail.xhr.response);
                errorDisplay.textContent = errorData.error || 'An error occurred. Please try again.';
            } catch (e) {
                errorDisplay.textContent = 'An error occurred. Please check your input and try again.';
            }
            errorDisplay.style.display = 'block';
        });
        
        // Input validation
        document.addEventListener('DOMContentLoaded', function() {
            const ipInput = document.getElementById('ip');
            const currentMaskInput = document.getElementById('current_mask');
            const newMaskInput = document.getElementById('new_mask');
            
            // Simple IP address validation
            ipInput.addEventListener('input', function(e) {
                const value = e.target.value;
                if (value.length > 0 && !/^[0-9.]+$/.test(value)) {
                    e.target.setCustomValidity('Please enter a valid IP address (numbers and dots only)');
                } else {
                    e.target.setCustomValidity('');
                }
            });
            
            // Mask validation
            const validateMask = (e) => {
                const value = e.target.value;
                if (value.length > 0) {
                    if (/^\d+$/.test(value)) {
                        // CIDR notation (e.g., 24)
                        const num = parseInt(value, 10);
                        if (num < 0 || num > 32) {
                            e.target.setCustomValidity('CIDR notation must be between 0 and 32');
                            return;
                        }
                    } else if (!/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(value)) {
                        e.target.setCustomValidity('Invalid mask format. Use CIDR (e.g., 24) or dotted decimal (e.g., 255.255.255.0)');
                        return;
                    }
                }
                e.target.setCustomValidity('');
            };
            
            currentMaskInput.addEventListener('input', validateMask);
            newMaskInput.addEventListener('input', validateMask);
        });
    </script>
    <footer>
        <p>&copy; 2025 Network App. All rights reserved.</p>
    </footer>
    </div>
</body>
</html>
